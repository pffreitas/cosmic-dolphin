alerts:
- rule: DEPLOYMENT_FAILED
- rule: DOMAIN_FAILED

domains:
- domain: api-nodejs.cosmic-dolphin.com
  type: PRIMARY
  zone: cosmic-dolphin.com

envs:
- key: NODE_ENV
  scope: RUN_AND_BUILD_TIME
  value: production
- key: DATABASE_URL
  scope: RUN_AND_BUILD_TIME
  value: ${DATABASE_URL}
- key: REDIS_URL
  scope: RUN_AND_BUILD_TIME
  value: ${REDIS_URL}
- key: JWT_SECRET
  scope: RUN_AND_BUILD_TIME
  value: ${JWT_SECRET}

features:
- buildpack-stack=ubuntu-22

ingress:
  rules:
  - component:
      name: cosmic-dolphin-api-nodejs
    match:
      path:
        prefix: /

name: cosmic-dolphin-api-nodejs
region: nyc

services:
- environment_slug: node-js
  github:
    branch: main
    deploy_on_push: true
    repo: pffreitas/cosmic-dolphin
  http_port: 3000
  instance_count: 1
  instance_size_slug: apps-s-1vcpu-0.5gb
  name: cosmic-dolphin-api-nodejs
  build_command: |
    npm ci
    npm run build --workspace=packages/shared
    npm run build --workspace=packages/api
  run_command: npm run start --workspace=packages/api
  source_dir: /